from django.db import models
from django.core.serializers.json import DjangoJSONEncoder
from reportcreator_api.archive.crypto.fields import EncryptedField

from reportcreator_api.utils.models import BaseModel


class OperationalTransformationEventType(models.TextChoices):
    CREATE = 'collab.create', 'Create'
    UPDATE_KEY = 'collab.update_key', 'Update Key'
    UPDATE_TEXT = 'collab.update_text', 'Update Text'
    DELETE = 'collab.delete', 'Delete'


class OperationalTransformationEvent(BaseModel):
    related_id = models.UUIDField(db_index=True)
    path = models.TextField(db_index=True)
    type = models.CharField(choices=OperationalTransformationEventType.choices, max_length=30, db_index=True)
    version = models.FloatField(db_index=True)
    data = EncryptedField(base_field=models.JSONField(encoder=DjangoJSONEncoder, default=dict))

